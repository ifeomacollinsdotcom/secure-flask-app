- name: Copy app files
  copy:
    src: "{{ item }}"
    dest: "{{ app_dir }}/"
    owner: "{{ flask_user }}"
    group: "{{ flask_user }}"
  loop:
    - flask_app.zip
    - hash.txt

- name: Verify checksum
  command: "sha256sum -c hash.txt"
  args:
    chdir: "{{ app_dir }}"
  register: checksum_result
  failed_when: "'OK' not in checksum_result.stdout"

- name: Extract application files
  unarchive:
    src: "{{ app_dir }}/flask_app.zip"
    dest: "{{ app_dir }}"
    remote_src: yes
    owner: "{{ flask_user }}"
    group: "{{ flask_user }}"
    extra_opts: "-jo"

- name: Verify extracted files
  stat:
    path: "{{ app_dir }}/{{ item }}"
  loop:
    - app.py
    - requirements.txt
  register: extracted_files

- name: Fail if files missing
  fail:
    msg: "Missing {{ item.item }} after extraction"
  when: not item.stat.exists
  loop: "{{ extracted_files.results }}"


