---
- name: Install required packages
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: present
  become: yes

- name: Create app directory
  file:
    path: /opt/flask-app
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  become: yes

- name: Calculate artifact checksum
  stat:
    path: "{{ workspace }}/artifact.tar.gz"
    checksum_algorithm: sha256
  register: actual_checksum
  delegate_to: localhost

- name: Read expected checksum
  slurp:
    src: "{{ workspace }}/hash.txt"
  register: expected_checksum_b64
  delegate_to: localhost

- name: Verify artifact integrity
  fail:
    msg: "Artifact integrity check failed. Expected: {{ expected_checksum_decoded }} but got: {{ actual_checksum.stat.checksum }}"
  when: actual_checksum.stat.checksum != expected_checksum_decoded
  vars:
    expected_checksum_decoded: "{{ expected_checksum_b64.content | b64decode | trim }}"

- name: Extract application files
  unarchive:
    src: "{{ workspace }}/artifact.tar.gz"
    dest: /opt/flask-app
    owner: ubuntu
    group: ubuntu
  become: yes

- name: Create Python virtual environment
  command: python3 -m venv /opt/flask-app/venv
  args:
    creates: /opt/flask-app/venv
  become: yes
  become_user: ubuntu

- name: Install Python dependencies
  pip:
    requirements: /opt/flask-app/requirements.txt
    virtualenv: /opt/flask-app/venv
  become: yes
  become_user: ubuntu

- name: Set up systemd service for Flask app
  template:
    src: flask-app.service.j2
    dest: /etc/systemd/system/flask-app.service
  become: yes

- name: Start and enable Flask app service
  systemd:
    name: flask-app
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes