---
- name: Configure Nginx with Certbot on Ubuntu
  hosts: n1
  become: yes
  vars:
    certbot_email: "ifeomalcollins@gmail.com"  
    domains:
      - "yourdomain.com"  
      - "www.yourdomain.com"

  tasks:
    - name: Gather package facts
      package_facts:
        manager: auto

    - name: Update apt package index
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Nginx
      apt:
        name: nginx
        state: latest
        install_recommends: no
      notify: Enable and start Nginx service

    - name: Install UFW if needed
      apt:
        name: ufw
        state: present
      when: "'ufw' not in ansible_facts.packages"

    - name: Configure UFW for Nginx
      ufw:
        rule: allow
        name: 'Nginx Full'
      when: "'ufw' in ansible_facts.packages"

    - name: Install Certbot components
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: latest
      notify: Verify Certbot installation

    - name: Run Certbot for SSL
      command: |
        certbot --nginx --non-interactive --agree-tos \
        --email "{{ certbot_email }}" \
        -d "{{ domains|join(',') }}" \
        --redirect --hsts --uir
      register: certbot_run
      changed_when: "'Successfully' in certbot_run.stdout"
      when: "'certbot' in ansible_facts.packages"
      notify: Reload Nginx

  handlers:
    - name: Enable and start Nginx service
      service:
        name: nginx
        enabled: yes
        state: started

    - name: Verify Certbot installation
      command: certbot --version
      register: certbot_version
      changed_when: false

    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded